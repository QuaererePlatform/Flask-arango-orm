version: 2.1
jobs:

  install_deps_py38:
    docker:
      - image: cimg/python:3.8
    steps:
      - checkout
      - restore_cache:
          key: v1-dependency-cache-{{ .Branch }}-{{ checksum "poetry.lock" }}-py38
      - run:
          name: Install package dependencies
          command: |
            poetry install
      - save_cache:
          key: v1-dependency-cache-{{ .Branch }}-{{ checksum "poetry.lock" }}-py38
          paths:
            - "venv"

  unittest_py38:
    docker:
      - image: cimg/python:3.8
    environment:
      PYTEST_ADDOPTS: --cov-report=xml:test-reports/coverage.xml --junitxml=test-reports/junit.xml
    steps:
      - checkout
      - restore_cache:
          key: v1-dependency-cache-{{ .Branch }}-{{ checksum "poetry.lock" }}-py38
      - run:
          name: Run tests
          command: |
            poetry run pytest
      - store_test_results:
          path: test-reports
      - store_artifacts:
          path: test-reports

workflows:
  version: 2

  build_test_publish_py38:
    jobs:
      - install_deps_py38
      - unittest_py38:
          requires:
            - install_deps_py38
